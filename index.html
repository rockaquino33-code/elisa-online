// scripts/desktop.js

const windowsContainer = document.getElementById('windows-container');
let openApps = {};
let maxOpenApps = 10; // Limite inicial de apps abertos

// Login
function login() {
  const username = document.getElementById('username').value;
  const password = document.getElementById('password').value;
  if(username && password){
    document.getElementById('login-screen').classList.add('hidden');
    document.getElementById('desktop').classList.remove('hidden');
    preloadApps();
  } else {
    alert('Digite usuário e senha.');
  }
}

// Pré-carregamento turbo de apps
function preloadApps() {
  const apps = ['office','chatgpt','teams','whatsapp','spotify','youtube','netflix','prime','games','files'];
  apps.forEach(app => openApps[app] = null);
}

// Abrir app
function openApp(appName) {
  if(Object.values(openApps).filter(w => w !== null).length >= maxOpenApps){
    alert('Sistema em uso alto, feche algumas janelas antes.');
    return;
  }
  if(openApps[appName] !== null){
    openApps[appName].style.zIndex = getMaxZIndex()+1;
    return;
  }

  const win = document.createElement('div');
  win.classList.add('window');
  win.innerHTML = `
    <div class="window-header">
      <span>${capitalize(appName)}</span>
      <div class="window-controls">
        <button onclick="closeApp('${appName}')">X</button>
      </div>
    </div>
    <div class="window-body">
      <iframe src="apps/${appName}.html" frameborder="0"></iframe>
    </div>
  `;
  win.style.zIndex = getMaxZIndex()+1;
  windowsContainer.appendChild(win);
  openApps[appName] = win;
  makeDraggable(win);
}

// Fechar app
function closeApp(appName){
  if(openApps[appName]){
    windowsContainer.removeChild(openApps[appName]);
    openApps[appName] = null;
  }
}

// Z-index máximo
function getMaxZIndex(){
  const zIndexes = Array.from(windowsContainer.children).map(c => parseInt(window.getComputedStyle(c).zIndex) || 0);
  return zIndexes.length ? Math.max(...zIndexes) : 0;
}

// Draggable
function makeDraggable(el){
  let pos1=0,pos2=0,pos3=0,pos4=0;
  const header = el.querySelector('.window-header');
  if(header) header.onmousedown=dragMouseDown;

  function dragMouseDown(e){
    e.preventDefault();
    pos3=e.clientX;
    pos4=e.clientY;
    document.onmouseup=closeDragElement;
    document.onmousemove=elementDrag;
  }
  function elementDrag(e){
    e.preventDefault();
    pos1=pos3-e.clientX;
    pos2=pos4-e.clientY;
    pos3=e.clientX;
    pos4=e.clientY;
    el.style.top=(el.offsetTop-pos2)+'px';
    el.style.left=(el.offsetLeft-pos1)+'px';
  }
  function closeDragElement(){
    document.onmouseup=null;
    document.onmousemove=null;
  }
}

function capitalize(str){ return str.charAt(0).toUpperCase()+str.slice(1); }

// Monitor de memória/processador (simulado)
setInterval(()=>{
  const used = Object.values(openApps).filter(w => w!==null).length;
  if(used>=maxOpenApps) maxOpenApps=used;
},5000);

/////////////////////////////
// INTEGRAÇÃO COM CHAT GPT //
/////////////////////////////

// Recebe comando do Chat GPT
async function executarComandoElisa(comando){
  comando = comando.toLowerCase();

  // Abrir apps
  if(comando.includes('abrir office')) openApp('office');
  else if(comando.includes('abrir teams')) openApp('teams');
  else if(comando.includes('abrir spotify')) openApp('spotify');
  else if(comando.includes('abrir youtube')) openApp('youtube');
  else if(comando.includes('abrir whatsapp')) openApp('whatsapp');
  else if(comando.includes('abrir netflix')) openApp('netflix');
  else if(comando.includes('abrir prime')) openApp('prime');
  else if(comando.includes('abrir jogos') || comando.includes('abrir games')) openApp('games');
  else if(comando.includes('abrir arquivos') || comando.includes('abrir pendrive')) openApp('files');

  // Sugerir ações
  else if(comando.includes('criar documento')) openApp('office');
  else if(comando.includes('tocar música')) openApp('spotify');
}

// Conectar chat GPT com a Elisa
function initChatGPTIntegration(){
  const chatFrame = document.querySelector('#windows-container iframe[src*="chatgpt"]');
  if(!chatFrame) return;

  const chatWindow = chatFrame.contentWindow;

  // Receber mensagens do chat GPT
  window.addEventListener('message', e=>{
    if(e.data?.type==='elisa-comando'){
      executarComandoElisa(e.data.comando);
    }
  });
}

setInterval(initChatGPTIntegration, 3000);
